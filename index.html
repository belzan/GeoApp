<!DOCTYPE html>
<html>
  <head>
    <title>Device Properties Example</title>

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script> 

    <script type="text/javascript" src="phonegap.js"></script>

    <script type="text/javascript">        
    



    var Count = 0;
    var blaat = setInterval("TelDieShit()",1000);
    var watchID = null;
    var Fire = 0;
	var Calibreer = 0;
    var Nick = "";
	var calibrationList = [];
	var curLat = 0;
	var curLon = 0;
	var oriLat = 0;
	var oriLon = 0;

    function onBodyLoad() { 
        document.addEventListener("deviceready", onDeviceReady, false);
      }

    function onDeviceReady() { 
        $("#submit").on("click",function(){
            Nick = $("#naam").val();
           $(".wrappert").hide(100);
            watchId = navigator.geolocation.watchPosition(onSuccess, onError,{ timeout: 5000,  enableHighAccuracy: true, maximumAge: 3000 }); 
        })				      
    }

    function onSuccess(position) {
        var element = document.getElementById('geolocation');
        element.innerHTML = 'Latitude: '           + position.coords.latitude + '<br />' +
                            'Longitude: '          + position.coords.longitude + '<br />' +
                            'Altitude: '           + position.coords.altitude   + '<br />' +
                            'Accuracy: '           + position.coords.accuracy   + '<br />' +
                            'Altitude Accuracy: '  + position.coords.altitudeAccuracy+ '<br />' +
                            'Heading: '            + position.coords.heading + '<br />' +
                            'Speed: '              + position.coords.speed  + '<br />' +
                            'Timestamp: '          + position.timestamp  + '<br />';
       Count = 0;      
      // $("#myiframe").attr("src","http://www.duwel.net/location.php?lat="+position.coords.latitude+"&lon="+position.coords.longitude+"&nick="+Nick+"&fire="+Fire);
       Fire = 0;
	   if (Calibreer == 1) {
			var distance = getdistance(curLat, curLon, position.coords.latitude, position.coords.longitude);
			var val = {"lat":position.coords.latitude,"lon":position.coords.longitude,"distance":distance};
			calibrationList.push(val);
			console.log(val);
			console.log(calibrationList);
			var element3 = document.getElementById('Movement');
            element3.innerHTML = distance;	
			SetOrigin(calibrationList);
	   }
	   
	   if (Calibreer == 2) {
			var distance2 = getdistance(oriLat, oriLon, position.coords.latitude, position.coords.longitude);
	        var element5 = document.getElementById('Movement');
            element5.innerHTML = distance + " tot de oorsprong";	
	   }
	   
	   curLat = position.coords.latitude;
	   curLon = position.coords.longitude;	   
    }

    function onError(error) {
        alert('code: '    + error.code    + '\n' + 'message: ' + error.message + '\n');        
    }

    function TelDieShit(){
        Count++;
        var element2 = document.getElementById('Teller');
        element2.innerHTML = Count;       
    }

	$(document).ready(function () {
			$("#Vuur").on("click", function(){	
			Fire = 1;                
		})  
	})
	
	$(document).ready(function () {
			$("#Calibreer").on("click", function(){	
			if (Calibreer == 1) {
				Calibreer = 0;
			} else {
				Calibreer = 1;                
			}
		})  
	})
	
	function SetOrigin(list) {
		if (list.length > 10) {
			var counter = 0;
			var totalLat = 0;
			var totalLon = 0;
            jQuery.each(list, function (i, val) {
				if (val.distance < 0.1) {
					counter++;
					totalLat += val.lat;
					totalLon += val.lon;
					if (counter == 10) {
						oriLat = totalLat/10;
						oriLon = totalLon/10;
						var element4 = document.getElementById('Origin');
                        element4.innerHTML = "Point of origin; lat:" + oriLat + " lon:" + oriLon;  
						Calibreer = 2;
					}
				}						
			});
         }		
	}
	
	function getdistance(lat1, lon1, lat2, lon2){  // generally used geo measurement function
		var R = 6378.137; // Radius of earth in KM
		var dLat = (lat2 - lat1) * Math.PI / 180;
		var dLon = (lon2 - lon1) * Math.PI / 180;
		var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
		Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
		Math.sin(dLon/2) * Math.sin(dLon/2);
		var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
		var d = R * c;
		return d * 1000; // meters
	}	

    </script>

  </head>
  <body onload="onBodyLoad()">
    <p id="geolocation">Finding geolocation...</p>
    <p id="Teller">0</p>
	<p id="Movement">0</p>
	<p id="Origin">0</p>
    <div class="wrappert">
    Naam: <input id="naam" placeholder="Naam" type="text"></input><input id="submit" type="submit" value="Gaan!"></input>
    </div>

    <br>
    <br>
	<input id="Calibreer" type="submit" value="Calibreer"></input> 
    <input id="Vuur" type="submit" value="VUUR!"></input> 
    <br>
    <br>
    <!-- <iframe id="myiframe" width="280" height="100" src="http://www.duwel.net/location.php" ></iframe> -->

   

  </body>
</html>

